<fragment>
    <set-variable name="routes" value="@{
                JArray routes = (JArray)context.Variables["routes"];
                JArray outputRoutes = new JArray();
                string activeBackendId = (string)context.Variables["backendId"];
                string targetDeployment = (string)context.Variables["deployment-id"];
                for (int i = 0; i < routes.Count; i++)
                {
                    JObject route = (JObject)routes[i];
                    int currentPriority = route.Value<int>("priority");
                    int dynamicPriorityDefault = route.Value<int?>("dynamicPriorityDefault") ?? -1;
                    int dynamicPriorityDowngrade = route.Value<int?>("dynamicPriorityDowngrade") ?? -1;
                    int targetTPMLimit = route.Value<int?>("targetTPMLimit") ?? -1;
                    int consumedTPM = route.Value<int?>("consumedTPM") ?? 0;

                    if (dynamicPriorityDefault == -1 || dynamicPriorityDowngrade == -1 || targetTPMLimit == -1)
                    {
                        outputRoutes.Add(route);
                        continue;
                    }

                    string consumedTokensKey = route.Value<string>("backend-id") + "-" + targetDeployment + "-ConsumedTokens";
                    string remainingTokensKey = route.Value<string>("backend-id") + "-" + targetDeployment + "-RemainingTokens";
                    route["consumedTokensKey"] = consumedTokensKey;
                    route["remainingTokensKey"] = remainingTokensKey;
                    
                    if (context.Variables.ContainsKey(consumedTokensKey) && route["backend-id"].ToString() == activeBackendId)
                    {
                        int requestConsumedTokens = (int)context.Variables[consumedTokensKey];
                        int remainingTokens = (int)context.Variables[remainingTokensKey];
                        
                        // Calcualting the total consumed tokens so far
                        int consumedTokens = 5000000 - remainingTokens - requestConsumedTokens;

                        double consumedPercentage = (double)consumedTokens / (double)targetTPMLimit;
                        
                        route["consumedPercentage"] = consumedPercentage;

                        if (consumedPercentage > 0.8)
                        {
                            route["isThrottling"] = true;
                            route["retryAfter"] = DateTime.Now.AddSeconds(30);
                        }
                        else
                        {
                            // route["priority"] = dynamicPriorityDefault;
                            route["isThrottling"] = false;
                            route["retryAfter"] = DateTime.MinValue;
                        }
                    }
                    else
                    {
                        route["consumedKeyFound"] = context.Variables.ContainsKey(consumedTokensKey);
                        route["activeBackendMatch"] = route["backend-id"].ToString() == activeBackendId;

                    }
                    outputRoutes.Add(route);
                }

                return outputRoutes; 
            }" />
    <cache-store-value key="@((string)context.Variables.GetValueOrDefault<string>("routesCacheKey", "ALL-ROUTES"))" value="@((JArray)context.Variables["routes"])" duration="86400" />
</fragment>